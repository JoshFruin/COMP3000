@page
@model IndexModel
@{
    ViewData["Title"] = "Scans";
}
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<div class="text-center">
    <div class="container">
    <h1 class="display-4">Scans</h1>
    <!-- Trigger the modal with a button -->
    <button class="button" style="vertical-align:middle" data-toggle="modal" data-target="#myModal"><span>Scan </span></button>
  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          @*<button type="button" class="close" data-dismiss="modal">&times;</button>*@
          <h4 class="modal-title">Please Select the Type of scan you wish to use and enter your IP Address</h4>
        </div>
         @*<div class="modal-body"> <!--Change this to a dropdown and add a text box for the user to input their IP-->
             <div class="dropdown">
                <button onclick="scanops()" class="dropbtn">Select Scan Type</button>
                <div id="myDropdown" class="dropdown-content">
                 <a href="#">Quick Scan</a>
                <a href="#">Device Scan</a>
                <a href="#">OS Scan</a>
                <a href="#">Vuln Scan</a>
                <a href="#">Full Scan</a>
            </div>
        </div>*@
        <form action="/action_page.php">
            <label for="scan">Please Select a Scan:</label>
                <select id="scanselect" name="scanselect">
                    <option value="Quick Scan">Quick Scan</option>
                    <option value="Device Scan">Device Scan</option>
                    <option value="OS Scan">OS Scan</option>
                    <option value="Vuln Scan">Vuln Scan</option>
                    <option value="Full Scan">Full Scan</option>
                 </select>
            <input type="text" id="IPAddress" name="IPAdd" placeholder="Please Enter your IP Address/IP Address Range here"><br>
            <input type="submit" value="submit">
            </form> 
        <?php
         if(isset($_POST['IPAdd'])){
             $selectedIP = $_POST['IPAdd']
         }
         @*if(isset($_POST['submit'])){
            if(!empty($_POST['scanselect'])) {
          $selectedscan = $_POST['scanselect'];
          echo 'You have chosen a: ' . $selectedscan;*@
          @*Switch for each scan that the user may pick*@
          switch($_POST['submit']){
              case 'Quick Scan':
              exec('nmap -p 1-1024 -v -sS -A localhost', $QS_output);
              var_dump( $QS_output );
              break;
              case 'Device Scan':
              exec('nmap -p 1-1024 -v -sU localhost', $DS_output);
              var_dump( $DS_output );
              break;
              case 'OS Scan':
              exec('nmap -p 1-1024 -O -sV localhost', $OS_output);
              var_dump( $OS_output );
              break;
              case 'Vuln Scan':
              exec('nmap --script vuln localhost', $VS_output);
              var_dump( $VS_output );
              break;
              case 'Full Scan':
              exec('nmap -p- -v -sS -sV -sC -A -O --script vuln localhost', $FS_output);
              var_dump( $FS_output );
              break;

              default:
          }
         @*}*@
        @*Parsing the data into an xml file then into the database below*@
        $file = file('nmapResults.xml');

        $servername = "localhost";
        $username = "nmap_user";
        $password = "123456";
        $db = "nmap";

        $conn = new mysqli($servername, $username, $password, $db);

        if ($conn->connect_error){
	        die("Connection failed: ". $conn->connect_error);
        }

        $ip;
        $mac;
        $vendor;
        $hostname;
        $port;
        $portArray = array();
        $portList;
        $timestamp;

        foreach($file as $line){
	
	        //Get IP Address
	        if (strpos($line, 'addrtype="ipv4"') == TRUE){
	        preg_match('/addr=".* addrtype/',$line,$results);
	        $ip = implode(" ",$results);
	        $ip = ltrim($ip, 'addr="');
	        $ip = rtrim($ip, '" addrtype');
	        print "<br><strong><u>Device</u></strong><br>";
	        print "IP Address:  $ip<br>";
	        }

	        //Get Vendor
	        if (strpos($line, 'addrtype="mac"') == TRUE){
	        preg_match('/vendor=".*"/',$line,$results);
	        $vendor = implode(" ",$results);
	        $vendor = ltrim($vendor,'vendor="');
	        $vendor = rtrim($vendor, '"');
	        print "Vendor: $vendor<br>";
	        }
	
	        //Get MAC Address
	        if (strpos($line, 'addrtype="mac"') == TRUE){
	        preg_match('/addr=".*" addrtype/',$line,$results);
	        $mac = implode(" ",$results);
	        $mac = ltrim($mac,'addr="');
	        $mac = rtrim($mac, '" addrtype');
	        print "MAC Address: $mac<br>";
	        }
	
	        //Get Hostname
	        if (strpos($line, 'type="PTR"') == TRUE){
	        preg_match('/name=".*" type/',$line,$results);
	        $hostname = implode(" ",$results);
	        $hostname = ltrim($hostname,'name="');
	        $hostname = rtrim($hostname, ' type');
	        $hostname = rtrim($hostname, '"');
	        print "Hostname:  $hostname<br>";
	        }
	
	        //Get Ports
	        if (strpos($line, 'portid="') == TRUE){
	        preg_match('/portid=".*><state/',$line,$results);
	        $port = implode(" ",$results);
	        $port = ltrim($port,'portid="');
	        $port = rtrim($port, '"><state');
	        print "Port: $port<br>";
	        #array_push($portArray, $port);
	        }

	        //Add Values to Database
	        if (strpos($line, '/host>') == TRUE){
	        $timestamp = time();	
	        $portList = implode(", ",$portArray);
            @*uniqid(rand())*@
            $ID = rand(100000,999999)
	        $sql = "insert into log(ip,mac,vendor,hostname,ports,timestamp) values ('$ip','$mac','$vendor','$hostname','$portList','$timestamp')";
            @*$sql = "insert into log(quickscanid,deviceip,devicemac,vendor,hostname,ports,timestamp) values ('$ID','$ip','$mac','$vendor','$hostname','$timestamp')";*@

	        if ($conn->query($sql) === TRUE) {
		        echo "Data Added: $ip  - $mac - $vendor - $hostname - $portList - $timestamp <br>";
	        } else {
		        echo "Error: ".$sql."<br>".$conn->error;
	        }
	        $ip = " ";
	        $mac = " ";
	        $vendor = " ";
	        $hostname = " ";
	        @*unset($portArray);
	        $portArray = array();*@
	        $portList = " ";
	        }

        }

        $conn->close();
        ?>
        @*exec('nmap -p 586 -sU xx.xx.xx.xx', $output); 
        var_dump( $output );*@
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
      
        </div>
    </div>
</div>
