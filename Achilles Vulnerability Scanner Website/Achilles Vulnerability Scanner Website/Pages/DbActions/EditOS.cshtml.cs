using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MySql.Data.MySqlClient;
using static Achilles_Vulnerability_Scanner_Website.Pages.IndexModel;

namespace Achilles_Vulnerability_Scanner_Website.Pages.DbActions
{
    public class EditOSModel : PageModel
    {
        public OSDataList OSdata = new OSDataList();
        public String errorMessage = "";
        public String successMessage = "";
        public void OnGet()
        {
            String OSID = Request.Query["OSID"];
            try
            {
                string constring = "server=localhost;database=scannerdbmk3;uid=root;pwd=C4bbages!;AllowUserVariables=True;";
                using (MySqlConnection conn = new MySqlConnection(constring))
                {
                    conn.Open();
                    var OScmdString = "SELECT * FROM scannerdbmk3.oscandata WHERE OSID=@OSID";
                    using (MySqlCommand command = new MySqlCommand(OScmdString, conn))
                    {
                        command.Parameters.AddWithValue("@OSID", OSID);
                        using (MySqlDataReader reader = command.ExecuteReader())
                        {
                            try
                            {
                                if (reader.Read())
                                {
                                    OSdata.OSID = "" + reader.GetInt32(0);
                                    OSdata.ScanIP = reader.GetString(1);
                                    OSdata.ScanVendor = reader.GetString(2);
                                    OSdata.ScanOS = reader.GetString(3);
                                    OSdata.IsOSOutdated = reader.GetString(4);
                                    OSdata.ScanMAC = reader.GetString(5);
                                    OSdata.ScanHostname = reader.GetString(6);
                                    OSdata.ScanPorts = reader.GetString(7);
                                    OSdata.ScanCompletionTime = reader.GetString(8);
                                }
                            }

                            catch (Exception ex)
                            {
                                errorMessage = ex.Message;
                                Console.WriteLine(errorMessage);
                                Console.WriteLine(ex.StackTrace);
                            }
                        }

                    }
                }
            }
            catch (Exception ex)
            {
                errorMessage = ex.Message;
                Console.WriteLine(errorMessage);
                Console.WriteLine(ex.StackTrace);
            }
        }

        public void OnPost()
        {
            OSdata.OSID = Request.Form["OSID"];
            OSdata.ScanIP = Request.Form["ScanIP"];
            OSdata.ScanVendor = Request.Form["ScanVendor"];
            OSdata.ScanOS = Request.Form["ScanOS"];
            OSdata.IsOSOutdated = Request.Form["IsOSOutdated"];
            OSdata.ScanMAC = Request.Form["ScanMAC"];
            OSdata.ScanHostname = Request.Form["ScanHostname"];
            OSdata.ScanPorts = Request.Form["ScanPorts"];
            OSdata.ScanCompletionTime = Request.Form["ScanCompletionTime"];

            if (OSdata.OSID.Length == 0 || OSdata.ScanIP.Length == 0 || OSdata.ScanVendor.Length == 0 || OSdata.ScanOS.Length == 0 || OSdata.ScanMAC.Length == 0 ||
                OSdata.ScanHostname.Length == 0 || OSdata.ScanPorts.Length == 0 || OSdata.IsOSOutdated.Length == 0 ||
                OSdata.ScanCompletionTime.Length == 0) 
            {
                errorMessage = "  fields are required to be filled";
                return;
            }

            //Alters Database with new user entered data
            try
            {
                string constring = "server=localhost;database=scannerdbmk3;uid=root;pwd=C4bbages!;AllowUserVariables=True;";
                MySqlConnection conn = new MySqlConnection(constring);

                var OScmdString = "UPDATE scannerdbmk3.oscandata SET ScanIP=@ScanIP, ScanVendor=@ScanVendor, ScanOS=@ScanOS, IsOSOutdated=@IsOSOutdated, ScanMAC=@ScanMAC, ScanHostname=@ScanHostname, ScanPorts=@ScanPorts, ScanCompletionTime=@ScanCompletionTime" + 
                    " WHERE OSID=@OSID";

                using (MySqlCommand command = new MySqlCommand(OScmdString, conn))
                {
                    //Parsed values are inserted into the database if an error occurs the user will get an error
                    try
                    {
                        command.Parameters.AddWithValue("@OSID", OSdata.OSID);
                        command.Parameters.AddWithValue("@ScanIP", OSdata.ScanIP);
                        command.Parameters.AddWithValue("@ScanVendor", OSdata.ScanVendor);
                        command.Parameters.AddWithValue("@ScanOS", OSdata.ScanOS);
                        command.Parameters.AddWithValue("@ScanMAC", OSdata.ScanMAC);
                        command.Parameters.AddWithValue("@ScanHostname", OSdata.ScanHostname);
                        command.Parameters.AddWithValue("@ScanPorts", OSdata.ScanPorts);
                        command.Parameters.AddWithValue("@IsOSOutdated", OSdata.IsOSOutdated);
                        command.Parameters.AddWithValue("@ScanCompletionTime", OSdata.ScanCompletionTime);
                        conn.Open();
                        command.ExecuteNonQuery();

                        Console.WriteLine("Data transfer successful");
                        //conn.Close();
                    }
                    catch (Exception ex)
                    {
                        //Perhaps do a pop-up in case any errors occur?
                        Console.WriteLine("Data transfer failed");
                        throw new Exception(
                                String.Format("Error executing the command '{0}'. The error is '{1}'.",
                                              command, ex.Message));
                    }

                }
            }

            catch (Exception ex)
            {
                errorMessage = ex.Message;
                return;
            }
            OSdata.OSID = ""; OSdata.ScanIP = ""; OSdata.ScanVendor = ""; OSdata.ScanOS = ""; OSdata.ScanMAC = "";
            OSdata.ScanHostname = ""; OSdata.ScanPorts = ""; OSdata.IsOSOutdated = "";
            OSdata.ScanCompletionTime = ""; 
            successMessage = "Data Altered";
            Response.Redirect("/ScanDatabase");
        }
    }
}
