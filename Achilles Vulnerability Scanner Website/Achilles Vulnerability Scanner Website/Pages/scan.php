namespace Achilles_Vulnerability_Scanner_Website.Pages
{
    public class scan
    {
     <?php
         if(isset($_POST['save_options'])){
            if(!empty($_POST['scanselect'])) {
          $selectedscan = $_POST['scanselect'];
          echo 'You have chosen a: ' . $selectedscan;
          #Switch for each scan that the user may pick
		  if(isset($_POST['scanselect'])){
			  $selectedIP = $_POST['IPAdd'];
			  switch($_POST['scanselect']){
				  case 'Quick Scan':
				  exec("nmap -p 1-1024 -v -sS -A $selectedIP", $QS_output);
				  var_dump( $QS_output );
				  break;
				  case 'Device Scan':
				  exec("nmap -p 1-1024 -v -sU $selectedIP" localhost, $DS_output);
				  var_dump( $DS_output );
				  break;
				  case 'OS Scan':
				  exec("nmap -p 1-1024 -O -sV $selectedIP", $OS_output);
				  var_dump( $OS_output );
				  break;
				  case 'Vuln Scan':
				  exec("nmap --script vuln $selectedIP", $VS_output);
				  var_dump( $VS_output );
				  break;
				  case 'Full Scan':
				  exec("nmap -p- -v -sS -sV -sC -A -O --script vuln $selectedIP", $FS_output);
				  var_dump( $FS_output );
				  break;

				  default:
			  }
		  }
         #}
		#Creating the xml file to store the nmap data to parse into mySQL
		$xml = new DOMDocument(1.0);

		#$xml->encoding = 'utf-8';
		#$xml->xmlVersion = '1.0';
		$xml->formatOutput = true;

		$xml_file_name = 'nmapResults.xml';
			$quickscan = $dom->createElement('quickscan');
			$xml->appendChild($quickscan);
		$child_QS = $xml->createElement("quickscan");
		#$child_QS->setAttribute();
		$quickscan->appendChild($child_QS)
		$deviceip = $xml->createElement("deviceip")
		$child_QS->appendChild(deviceip)

			echo "<xmp>".	$xml->saveXML()."</xmp>";


				

	echo "$xml_file_name has been successfully created";



        #Parsing the data into an xml file then into the database below
        $file = file('nmapResults.xml');

        $servername = "localhost:3306"; #localhost:3306 or localhost
        $username = "root@localhost";
        $password = "C4bbages!";
        $db = "scannerdbmk2";

        $conn = new mysqli($servername, $username, $password, $db);

        if ($conn->connect_error){
	        die("Connection failed: ". $conn->connect_error);
        }

        $ip;
        $mac;
        $vendor;
        $hostname;
        $port;
        $portArray = array();
        $portList;
        $timestamp;

        foreach($file as $line){
	
	        //Get IP Address
	        if (strpos($line, 'addrtype="ipv4"') == TRUE){
	        preg_match('/addr=".* addrtype/',$line,$results);
	        $ip = implode(" ",$results);
	        $ip = ltrim($ip, 'addr="');
	        $ip = rtrim($ip, '" addrtype');
	        #print "<br><strong><u>Device</u></strong><br>";
	        #print "IP Address:  $ip<br>";
	        }

	        //Get Vendor
	        if (strpos($line, 'addrtype="mac"') == TRUE){
	        preg_match('/vendor=".*"/',$line,$results);
	        $vendor = implode(" ",$results);
	        $vendor = ltrim($vendor,'vendor="');
	        $vendor = rtrim($vendor, '"');
	        #print "Vendor: $vendor<br>";
	        }
	
	        //Get MAC Address
	        if (strpos($line, 'addrtype="mac"') == TRUE){
	        preg_match('/addr=".*" addrtype/',$line,$results);
	        $mac = implode(" ",$results);
	        $mac = ltrim($mac,'addr="');
	        $mac = rtrim($mac, '" addrtype');
	        #print "MAC Address: $mac<br>";
	        }
	
	        //Get Hostname
	        if (strpos($line, 'type="PTR"') == TRUE){
	        preg_match('/name=".*" type/',$line,$results);
	        $hostname = implode(" ",$results);
	        $hostname = ltrim($hostname,'name="');
	        $hostname = rtrim($hostname, ' type');
	        $hostname = rtrim($hostname, '"');
	        #print "Hostname:  $hostname<br>";
	        }
	
	        //Get Ports
	        if (strpos($line, 'portid="') == TRUE){
	        preg_match('/portid=".*><state/',$line,$results);
	        $port = implode(" ",$results);
	        $port = ltrim($port,'portid="');
	        $port = rtrim($port, '"><state');
	        #print "Port: $port<br>";
	        #array_push($portArray, $port);
	        }

	        //Add Values to Database
	        if (strpos($line, '/host>') == TRUE){
	        $timestamp = time();	
	        $portList = implode(", ",$portArray);
	        $sql = "insert into log(ip,mac,vendor,hostname,ports,timestamp) values ('$ip','$mac','$vendor','$hostname','$portList','$timestamp')";
            $sql = "insert into log(quickscanid,deviceip,devicemac,vendor,hostname,ports,timestamp) values ('$ID','$ip','$mac','$vendor','$hostname','$timestamp')";

	        if ($conn->query($sql) === TRUE) {
		        echo "Data Added: $ip  - $mac - $vendor - $hostname - $portList - $timestamp <br>";
	        } else {
		        echo "Error: ".$sql."<br>".$conn->error;
	        }
	        $ip = " ";
	        $mac = " ";
	        $vendor = " ";
	        $hostname = " ";
	        unset($portArray);
	        $portArray = array();
	        $portList = " ";
	        }

        }

        $conn->close();
        ?>
    }
}
