using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using MySql.Data.MySqlClient;
using System.Data;

namespace Achilles_Vulnerability_Scanner_Website.Pages
{
    public class IndexModel : PageModel
    {
        private readonly ILogger<IndexModel> _logger;

        public IndexModel(ILogger<IndexModel> logger)
        {
            _logger = logger;
        }

        public List<QSData> QuickData { get; set; }
        public List<DSData> DiscoData { get; set; }
        public List<OSDataList> OSData { get; set; }

        public class QSData 
        {
            public string QSID { get; set; }
            public string ScanIP { get; set; }
            public string ScanVendor { get; set; } 
            public string ScanOS { get; set; }
            public string ScanOSFamily { get; set; }
            public string ScanMAC { get; set; } 
            public string ScanHostname { get; set; }
            public string ScanPorts { get; set; }
            public string ScanPortServices { get; set; } 
            public string ClosedPorts { get; set; } 
            public string ScanCompletionTime { get; set; }
        }
        public class DSData
        {
            public string DiscoID { get; set; }
            public string ScanIP { get; set; }
            public string ScanVendor { get; set; }
            public string ScanMAC { get; set; }
            public string ScanHostname { get; set; }
            public string ScanPorts { get; set; }
            public string ScanCompletionTime { get; set; }
        }
        public class OSDataList
        {
            public string OSID { get; set; }
            public string ScanIP { get; set; }
            public string ScanVendor { get; set; }
            public string ScanOS { get; set; }
            public string ScanOSFamily { get; set; }
            public string ScanMAC { get; set; }
            public string ScanHostname { get; set; }
            public string ScanPorts { get; set; }
            public string ScanCompletionTime { get; set; }
        }
        public void OnGet()
        {
            OnPost();
        }
        public IActionResult OnPost()
        {
            //MySqlConnection conn = new MySqlConnection("server=localhost;database=scannerdbmk3;uid=root;pwd=C4bbages!;AllowUserVariables=True;");
            //try
            //{
            //    string cmdString = "SELECT * FROM scannerdbmk3.quickscandata";
            //    MySqlCommand cmd = new MySqlCommand(cmdString, conn);
            //    //MySqlDataReader reader = cmd.ExecuteReader();
            //    MySqlDataReader reader;
            //    QuickData = new List<QSData>();
            //    //try
            //    //{
            //    conn.Open();
            //    cmd.CommandText = cmdString;
            //    reader = cmd.ExecuteReader();
            //    while (reader.Read())
            //    {
            //        QuickData.Add(new QSData()
            //        {
            //            QSID = reader["QSID"].ToString(),
            //            ScanIP = reader["ScanIP"].ToString(),
            //            ScanVendor = reader["ScanVendor"].ToString(),
            //            ScanOS = reader["ScanOS"].ToString(),
            //            ScanOSFamily = reader["ScanOSFamily"].ToString(),
            //            ScanMAC = reader["ScanMAC"].ToString(),
            //            ScanHostname = reader["ScanHostname"].ToString(),
            //            ScanPorts = reader["ScanPorts"].ToString(),
            //            ScanPortServices = reader["ScanPortServices"].ToString(),
            //            ClosedPorts = reader["ClosedPorts"].ToString(),
            //            ScanCompletionTime = reader["ScanCompletionTime"].ToString(),
            //        });
            //    }
            //    conn.Close();
            //    //}
            //    //catch (Exception ex)
            //    //{
            //    //    throw ex;
            //    //}
            //    string cmdString2 = "SELECT * FROM scannerdbmk3.discoscandata";
            //    MySqlCommand cmd2 = new MySqlCommand(cmdString2, conn);
            //    //MySqlDataReader reader = cmd.ExecuteReader();
            //    MySqlDataReader reader2;
            //    DiscoData = new List<DSData>();
            //    //try
            //    //{
            //    conn.Open();
            //    cmd2.CommandText = cmdString2;
            //    reader2 = cmd2.ExecuteReader();
            //    while (reader2.Read())
            //    {
            //        DiscoData.Add(new DSData()
            //        {
            //            DiscoID = reader2["DicsoID"].ToString(),
            //            ScanIP = reader2["ScanIP"].ToString(),
            //            ScanVendor = reader2["ScanVendor"].ToString(),
            //            ScanOS = reader2["ScanOS"].ToString(),
            //            ScanOSFamily = reader2["ScanOSFamily"].ToString(),
            //            ScanMAC = reader2["ScanMAC"].ToString(),
            //            ScanHostname = reader2["ScanHostname"].ToString(),
            //            ScanPorts = reader2["ScanPorts"].ToString(),
            //            ScanCompletionTime = reader2["ScanCompletionTime"].ToString(),
            //        });
            //    }
            //    conn.Close();
            //    //return RedirectToPage("./Index");
            //    //}
            //}
            //catch (Exception ex)
            //{
            //    throw ex;
            //}
            using (MySqlConnection conn = new MySqlConnection("server=localhost;database=scannerdbmk3;uid=root;pwd=C4bbages!;AllowUserVariables=True;"))
            {
                try
                {
                    conn.Open();

                    using (MySqlCommand cmd = new MySqlCommand("SELECT * FROM scannerdbmk3.quickscandata", conn))
                    using (var reader = cmd.ExecuteReader())
                    {
                        QuickData = new List<QSData>();
                        while (reader.Read())
                        {
                            QuickData.Add(new QSData()
                            {
                                QSID = reader["QSID"].ToString(),
                                ScanIP = reader["ScanIP"].ToString(),
                                ScanVendor = reader["ScanVendor"].ToString(),
                                ScanOS = reader["ScanOS"].ToString(),
                                ScanOSFamily = reader["ScanOSFamily"].ToString(),
                                ScanMAC = reader["ScanMAC"].ToString(),
                                ScanHostname = reader["ScanHostname"].ToString(),
                                ScanPorts = reader["ScanPorts"].ToString(),
                                ScanPortServices = reader["ScanPortServices"].ToString(),
                                ClosedPorts = reader["ClosedPorts"].ToString(),
                                ScanCompletionTime = reader["ScanCompletionTime"].ToString(),
                            });
                        }
                    }

                    using (MySqlCommand cmd = new MySqlCommand("SELECT * FROM scannerdbmk3.discoscandata", conn))
                    using (var reader = cmd.ExecuteReader())
                    {
                        DiscoData = new List<DSData>();
                        while (reader.Read())
                        {
                            DiscoData.Add(new DSData()
                            {
                                DiscoID = reader["DiscoID"].ToString(),
                                ScanIP = reader["ScanIP"].ToString(),
                                ScanVendor = reader["ScanVendor"].ToString(),
                                ScanMAC = reader["ScanMAC"].ToString(),
                                ScanHostname = reader["ScanHostname"].ToString(),
                                ScanPorts = reader["ScanPorts"].ToString(),
                                ScanCompletionTime = reader["ScanCompletionTime"].ToString(),
                            });
                        }
                    }
                    using (MySqlCommand cmd = new MySqlCommand("SELECT * FROM scannerdbmk3.oscandata", conn))
                    using (var reader = cmd.ExecuteReader())
                    {
                        OSData = new List<OSDataList>();
                        while (reader.Read())
                        {
                            OSData.Add(new OSDataList()
                            {
                                OSID = reader["OSID"].ToString(),
                                ScanIP = reader["ScanIP"].ToString(),
                                ScanVendor = reader["ScanVendor"].ToString(),
                                ScanOS = reader["ScanOS"].ToString(),
                                ScanOSFamily = reader["ScanOSFamily"].ToString(),
                                ScanMAC = reader["ScanMAC"].ToString(),
                                ScanHostname = reader["ScanHostname"].ToString(),
                                ScanPorts = reader["ScanPorts"].ToString(),
                                ScanCompletionTime = reader["ScanCompletionTime"].ToString(),
                            });
                        }
                    }
                }
                catch (Exception ex)
                {
                    throw ex;
                }              
            }
            return RedirectToPage("./Index");
        }
    }
}